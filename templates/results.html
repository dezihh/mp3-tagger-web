<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 Tagger Web - Ergebnisse</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="results-header">
        <h1>MP3 Tagger Web - Ergebnisse</h1>
        <div class="directory-info">
            <h2>üìÅ {{ mp3_dir }}</h2>
            <p>{{ statistics.total_files }} MP3-Dateien in {{ statistics.total_directories }} Verzeichnissen 
               ({{ "%.1f"|format(statistics.total_size_mb) }} MB)</p>
        </div>
    </div>
    
    <div class="controls-bar">
        <div class="global-controls">
            <label class="checkbox-container">
                <input type="checkbox" id="select-all-global">
                <span class="checkmark"></span>
                Alle Dateien ausw√§hlen/abw√§hlen
            </label>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="batch-process" disabled>
                Ausgew√§hlte verarbeiten (0)
            </button>
            <button id="audioRecognitionBtn" class="btn btn-secondary" title="Audio-Erkennung f√ºr fehlende Tags">
                üéµ Audio-Erkennung
            </button>
            <button id="albumRecognitionBtn" class="btn btn-info" title="Album-Erkennung f√ºr bessere Metadaten">
                üíø Album-Erkennung
            </button>
            <button id="batchSaveBtn" class="btn btn-success" disabled>
                <span id="saveCount">0</span> Dateien speichern
            </button>
            <a href="/" class="btn btn-secondary">‚Üê Zur√ºck</a>
        </div>
    </div>

    <div class="results-container">
        {% for directory, files in grouped_files.items() %}
        <div class="directory-group">
            <div class="directory-header">
                <h3>üìÇ {{ directory }}</h3>
                <div class="directory-controls">
                    <label class="checkbox-container">
                        <input type="checkbox" class="select-all-directory" data-directory="{{ directory }}">
                        <span class="checkmark"></span>
                        Alle in diesem Ordner ({{ files|length }})
                    </label>
                </div>
            </div>
            
            <div class="mp3-table-container">
                <table class="mp3-table">
                    <thead>
                        <tr>
                            <th class="col-select">Auswahl</th>
                            <th class="col-play">‚ñ∂</th>
                            <th class="col-filename">Dateiname</th>
                            <th class="col-track">Track#</th>
                            <th class="col-title">Titel</th>
                            <th class="col-artist">Artist</th>
                            <th class="col-album">Album</th>
                            <th class="col-cover">Cover</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                        <tr class="mp3-row" data-directory="{{ directory }}" data-filepath="{{ file.file_path }}">
                            <td class="col-select">
                                <label class="checkbox-container">
                                    <input type="checkbox" class="file-checkbox" 
                                           data-directory="{{ directory }}"
                                           data-filepath="{{ file.file_path }}">
                                    <span class="checkmark"></span>
                                </label>
                            </td>
                            <td class="col-play">
                                <button class="play-btn" data-filepath="{{ file.file_path }}" title="Abspielen">
                                    ‚ñ∂
                                </button>
                            </td>
                            <td class="col-filename" title="{{ file.filename }}">
                                <span class="filename hover-target">{{ file.filename }}</span>
                                <span class="file-size">({{ "%.1f"|format(file.size / 1024 / 1024) }} MB)</span>
                            </td>
                            <td class="col-track">
                                <input type="text" class="track-input" value="{{ file.track_number }}" 
                                       data-original="{{ file.track_number }}" maxlength="3">
                            </td>
                            <td class="col-title">
                                {% set display_title, is_recognized = get_display_title_for_template(file) %}
                                <input type="text" class="title-input {{ 'recognized-field' if is_recognized else '' }}" 
                                       value="{{ display_title }}" 
                                       data-original="{{ file.title }}"
                                       data-recognized="{{ file.recognized_title if file.recognized_title else '' }}"
                                       {{ 'title="Erkannt via ' + file.recognition_source + '"' if is_recognized else '' }}>
                            </td>
                            <td class="col-artist">
                                {% set display_artist, is_recognized = get_display_artist_for_template(file) %}
                                <input type="text" class="artist-input {{ 'recognized-field' if is_recognized else '' }}" 
                                       value="{{ display_artist }}" 
                                       data-original="{{ file.artist }}"
                                       data-recognized="{{ file.recognized_artist if file.recognized_artist else '' }}"
                                       {{ 'title="Erkannt via ' + file.recognition_source + '"' if is_recognized else '' }}>
                            </td>
                            <td class="col-album">
                                <input type="text" class="album-input {{ 'album-recognized-field' if file.album_recognized else '' }}" 
                                       value="{{ file.display_album }}" 
                                       data-original="{{ file.album }}"
                                       data-recognized="{{ file.recognized_album if file.recognized_album else '' }}"
                                       {{ 'title="Erkannt als Album-Metadaten"' if file.album_recognized else '' }}>
                            </td>
                            <td class="col-cover">
                                <span class="cover-status {{ 'has-cover' if file.cover_status != 'Nein' else 'no-cover' }}" 
                                      title="Cover-Status: {{ file.cover_status }}">
                                    {{ file.cover_status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Audio Player (versteckt) -->
        </div>

    <!-- Progress Overlay f√ºr Speichern -->
    <div id="saveProgressOverlay" class="save-progress-overlay">
        <div class="save-progress-box">
            <div class="save-progress-title">üíæ Tags werden gespeichert...</div>
            <div class="save-progress-bar">
                <div id="saveProgressFill" class="save-progress-fill"></div>
            </div>
            <div id="saveProgressText" class="save-progress-text">Vorbereitung...</div>
            <div id="saveProgressStatus" class="save-progress-status"></div>
        </div>
    </div>

    <audio id="audio-player" style="display: none;" controls></audio>

    <!-- Include reusable JavaScript utilities -->
    <script src="{{ url_for('static', filename='utils.js') }}"></script>

    <script>
        /* ==========================================
           MP3 TAGGER WEB - OPTIMIZED JAVASCRIPT
           ========================================== */

        // Globale Variablen f√ºr Zustandsverwaltung
        let selectedFiles = new Set();
        let currentAudio = null;
        let currentPlayButton = null;
        let tooltipElement = null;
        let tooltipTimeout = null;

        // DOM Ready - Initialisierung aller Funktionen
        document.addEventListener('DOMContentLoaded', function() {
            initializeControls();
            initializeAutoCheckbox();
            initializePlayback();
            initializeTooltips();
            initializeSaveFunction();
            initializeAudioRecognition();
            initializeAlbumRecognition();
            updateBatchButton();
        });

        /* === AUSWAHLKONTROLLE SYSTEM ===
         * Verwaltet Checkboxen auf drei Ebenen: Global, Directory, Individual
         */
        function initializeControls() {
            // Globale "Alle ausw√§hlen/abw√§hlen" Checkbox
            const globalSelect = document.getElementById('select-all-global');
            globalSelect.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.file-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    toggleFileSelection(cb.dataset.filepath, this.checked);
                });
                updateDirectorySelects();
                updateBatchButton();
            });

            // Verzeichnis-spezifische Auswahl
            const directorySelects = document.querySelectorAll('.select-all-directory');
            directorySelects.forEach(select => {
                select.addEventListener('change', function() {
                    const directory = this.dataset.directory;
                    const checkboxes = document.querySelectorAll(`.file-checkbox[data-directory="${directory}"]`);
                    
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                        toggleFileSelection(cb.dataset.filepath, this.checked);
                    });
                    updateGlobalSelect();
                    updateBatchButton();
                });
            });

            // Einzelne Datei-Checkboxen
            const fileCheckboxes = document.querySelectorAll('.file-checkbox');
            fileCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    toggleFileSelection(this.dataset.filepath, this.checked);
                    updateDirectorySelects();
                    updateGlobalSelect();
                    updateBatchButton();
                });
            });
        }

        /* === AUTO-CHECKBOX FUNKTION ===
         * Aktiviert automatisch Checkbox bei √Ñnderungen in Eingabefeldern
         */
        function initializeAutoCheckbox() {
            const inputFields = document.querySelectorAll('.title-input, .artist-input, .album-input, .year-input, .track-input, .genre-input');
            inputFields.forEach(input => {
                input.addEventListener('input', function() {
                    const row = this.closest('.mp3-row');
                    const checkbox = row.querySelector('.file-checkbox');
                    const filepath = checkbox.dataset.filepath;
                    
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        toggleFileSelection(filepath, true);
                        updateDirectorySelects();
                        updateGlobalSelect();
                        updateBatchButton();
                    }
                });
            });
        }

        /* === HILFSFUNKTIONEN F√úR AUSWAHL-MANAGEMENT === */
        function toggleFileSelection(filepath, selected) {
            if (selected) {
                selectedFiles.add(filepath);
            } else {
                selectedFiles.delete(filepath);
            }
        }

        function updateDirectorySelects() {
            const directorySelects = document.querySelectorAll('.select-all-directory');
            directorySelects.forEach(select => {
                const directory = select.dataset.directory;
                const checkboxes = document.querySelectorAll(`.file-checkbox[data-directory="${directory}"]`);
                const checkedBoxes = document.querySelectorAll(`.file-checkbox[data-directory="${directory}"]:checked`);
                
                select.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;
                select.checked = checkedBoxes.length > 0;
            });
        }

        function updateGlobalSelect() {
            const globalSelect = document.getElementById('select-all-global');
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
            
            globalSelect.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
            globalSelect.checked = checkedBoxes.length > 0;
        }

        function updateBatchButton() {
            const batchButton = document.getElementById('batch-process');
            const saveBtn = document.getElementById('batchSaveBtn');
            const saveCount = document.getElementById('saveCount');
            const count = selectedFiles.size;
            
            batchButton.textContent = `Ausgew√§hlte verarbeiten (${count})`;
            batchButton.disabled = count === 0;

            if (saveBtn && saveCount) {
                saveBtn.disabled = count === 0;
                saveCount.textContent = count;
            }
        }

        /* === AUDIO PLAYBACK SYSTEM ===
         * Verwaltet MP3-Wiedergabe mit Play/Pause-Buttons
         */
        function initializePlayback() {
            const playButtons = document.querySelectorAll('.play-btn');
            const audioPlayer = document.getElementById('audio-player');
            
            playButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filepath = this.dataset.filepath;
                    togglePlayback(this, filepath, audioPlayer);
                });
            });
        }

        function togglePlayback(button, filepath, audioPlayer) {
            // Aktuellen Track stoppen wenn derselbe Button geklickt
            if (currentAudio && !currentAudio.paused && currentPlayButton === button) {
                currentAudio.pause();
                resetPlayButton(button);
                currentAudio = null;
                currentPlayButton = null;
                return;
            }
            
            // Anderen Track stoppen falls vorhanden
            if (currentAudio) {
                currentAudio.pause();
                if (currentPlayButton) {
                    resetPlayButton(currentPlayButton);
                }
            }
            
            // Neuen Track starten
            const cleanPath = filepath.startsWith('/') ? filepath.substring(1) : filepath;
            audioPlayer.src = `/audio/${encodeURIComponent(cleanPath)}`;
            
            audioPlayer.play().then(() => {
                setPlayingButton(button);
                currentAudio = audioPlayer;
                currentPlayButton = button;
            }).catch(error => {
                console.error('Fehler beim Abspielen:', error);
                showUserMessage('Fehler beim Abspielen der Datei: ' + error.message, 'error');
            });
            
            // Event-Listener f√ºr Track-Ende (nur einmal hinzuf√ºgen)
            audioPlayer.removeEventListener('ended', handleTrackEnd);
            audioPlayer.addEventListener('ended', handleTrackEnd);
        }

        function handleTrackEnd() {
            if (currentPlayButton) {
                resetPlayButton(currentPlayButton);
            }
            currentAudio = null;
            currentPlayButton = null;
        }

        function setPlayingButton(button) {
            button.textContent = "‚è∏";
            button.classList.add('playing');
        }

        function resetPlayButton(button) {
            button.textContent = "‚ñ∂";
            button.classList.remove('playing');
        }

        /* === TOOLTIP SYSTEM ===
         * Hover-Tooltips mit detaillierten MP3-Informationen
         */
        function initializeTooltips() {
            // Tooltip-Element einmal erstellen
            tooltipElement = document.createElement('div');
            tooltipElement.className = 'mp3-tooltip';
            document.body.appendChild(tooltipElement);

            // Event-Listener f√ºr alle Dateinamen
            const filenames = document.querySelectorAll('.filename');
            filenames.forEach(filenameElement => {
                const row = filenameElement.closest('.mp3-row');
                const filepath = row.dataset.filepath;

                filenameElement.addEventListener('mouseenter', e => showTooltip(e, filepath));
                filenameElement.addEventListener('mouseleave', hideTooltip);
                filenameElement.addEventListener('mousemove', updateTooltipPosition);
            });
        }

        function showTooltip(event, filepath) {
            clearTimeout(tooltipTimeout);
            
            // Sofort Lade-Animation anzeigen
            tooltipElement.innerHTML = '<div class="tooltip-loading">Lade MP3-Informationen</div>';
            tooltipElement.classList.add('show');
            updateTooltipPosition(event);

            // MP3-Informationen via API laden mit optimierter makeApiCall
            const encodedPath = encodeURIComponent(filepath);
            makeApiCall(`/api/mp3-info?filepath=${encodedPath}`)
                .then(data => {
                    if (tooltipElement.classList.contains('show')) {
                        renderTooltipContent(data);
                    }
                })
                .catch(error => {
                    if (tooltipElement.classList.contains('show')) {
                        tooltipElement.innerHTML = '<div class="tooltip-error">Fehler beim Laden der Informationen</div>';
                    }
                });
        }

        function hideTooltip() {
            tooltipTimeout = setTimeout(() => {
                tooltipElement.classList.remove('show');
            }, 100);
        }

        function updateTooltipPosition(event) {
            const tooltip = tooltipElement;
            const margin = 10;
            let x = event.pageX + margin;
            let y = event.pageY + margin;

            // Bildschirm-Grenzen respektieren
            const tooltipRect = tooltip.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (x + tooltipRect.width > windowWidth) {
                x = event.pageX - tooltipRect.width - margin;
            }

            if (y + tooltipRect.height > windowHeight) {
                y = event.pageY - tooltipRect.height - margin;
            }

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        /* === TOOLTIP CONTENT RENDERING === */
        function renderTooltipContent(data) {
            if (data.error) {
                tooltipElement.innerHTML = `<div class="tooltip-error">${data.error}</div>`;
                return;
            }

            const sections = {
                technical: { icon: 'üìÑ', title: 'Datei-Info', data: data.technical },
                basic: { icon: 'üéµ', title: 'ID3-Tags', data: data.basic },
                extended: { icon: '‚ûï', title: 'Erweiterte Tags', data: data.extended }
            };

            let leftColumnHtml = '';
            let rightColumnHtml = '';

            // Linke Spalte: Technische und Tag-Informationen
            Object.entries(sections).forEach(([key, section]) => {
                if (section.data && Object.keys(section.data).length > 0) {
                    leftColumnHtml += buildSection(section.icon, section.title, section.data);
                }
            });

            // Rechte Spalte: Cover-Informationen
            if (data.cover) {
                rightColumnHtml = buildCoverSection(data.cover);
            }

            // HTML zusammenbauen
            let html = '<div class="tooltip-main-container">';
            if (leftColumnHtml) html += `<div class="tooltip-left-column">${leftColumnHtml}</div>`;
            if (rightColumnHtml) html += `<div class="tooltip-right-column">${rightColumnHtml}</div>`;
            html += '</div>';

            tooltipElement.innerHTML = html || '<div class="tooltip-error">Keine Informationen verf√ºgbar</div>';
        }

        function buildSection(icon, title, data) {
            let html = '<div class="tooltip-section">';
            html += `<div class="tooltip-header">${icon} ${title}</div>`;
            html += '<div class="tooltip-content">';
            
            Object.entries(data).forEach(([key, value]) => {
                const labels = {
                    'file_path': 'Datei', 'file_size': 'Gr√∂√üe', 'duration': 'Dauer',
                    'bitrate': 'Bitrate', 'sample_rate': 'Sample Rate', 'channels': 'Kan√§le'
                };
                html += `<div class="tooltip-label">${labels[key] || key}:</div>`;
                html += `<div class="tooltip-value">${value}</div>`;
            });
            
            html += '</div></div>';
            return html;
        }

        function buildCoverSection(cover) {
            let html = '<div class="tooltip-section">';
            html += '<div class="tooltip-header">üñºÔ∏è Cover</div>';
            
            if (cover.error) {
                html += `<div class="tooltip-error">${cover.error}</div>`;
            } else {
                if (cover.data) {
                    html += '<div class="tooltip-cover">';
                    html += `<img src="data:image/jpeg;base64,${cover.data}" alt="Cover Preview">`;
                    html += '</div>';
                }
                
                html += '<div class="tooltip-content">';
                html += `<div class="tooltip-label">Aufl√∂sung:</div><div class="tooltip-value">${cover.width}√ó${cover.height}</div>`;
                html += `<div class="tooltip-label">Gr√∂√üe:</div><div class="tooltip-value">${cover.size}</div>`;
                html += `<div class="tooltip-label">Format:</div><div class="tooltip-value">${cover.format}</div>`;
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        /* === TAG-SPEICHER-SYSTEM ===
         * Batch-Speichern mit Progress-Bar und automatischer Best√§tigung
         */
        function initializeSaveFunction() {
            const saveBtn = document.getElementById('batchSaveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveTags);
            }
        }

        function saveTags() {
            const filesToSave = collectFilesToSave();
            
            if (filesToSave.length === 0) {
                showUserMessage('Keine Dateien zum Speichern ausgew√§hlt.', 'warning');
                return;
            }

            // Progress-System starten
            const progressController = createProgressController();
            progressController.show();
            progressController.updateProgress(25, `√úbertrage ${filesToSave.length} Dateien...`);

            // API-Request ausf√ºhren
            performSaveRequest(filesToSave, progressController);
        }

        function collectFilesToSave() {
            const filesToSave = [];
            
            selectedFiles.forEach(filepath => {
                const row = document.querySelector(`[data-filepath="${filepath}"]`);
                if (row) {
                    const tags = {
                        title: row.querySelector('.title-input')?.value || '',
                        artist: row.querySelector('.artist-input')?.value || '',
                        album: row.querySelector('.album-input')?.value || '',
                        year: row.querySelector('.year-input')?.value || '',
                        track: row.querySelector('.track-input')?.value || '',
                        genre: row.querySelector('.genre-input')?.value || ''
                    };
                    
                    filesToSave.push({ filepath, tags });
                }
            });
            
            return filesToSave;
        }

        /* === SAVE PROGRESS CONTROLLER ===
         * Nutzt die wiederverwendbare createUniversalProgressController Funktion
         */
        function createProgressController() {
            const saveBtn = document.getElementById('batchSaveBtn');
            const controller = createUniversalProgressController({
                title: 'üíæ Tags werden gespeichert...'
            });
            
            return {
                show: (title) => {
                    saveBtn.disabled = true;
                    controller.show(title);
                    controller.updateProgress(0, 'Sammle Datei-Informationen...');
                },
                
                updateProgress: controller.updateProgress,
                
                hide: () => {
                    controller.hide();
                    saveBtn.disabled = false;
                }
            };
        }

        /* === SAVE REQUEST OPTIMIERT ===
         * Nutzt makeApiCall f√ºr saubere API-Kommunikation
         */
        async function performSaveRequest(filesToSave, progressController) {
            try {
                progressController.updateProgress(25, 'Sende Daten an Server...');
                
                const data = await makeApiCall('/api/save-tags', {
                    method: 'POST',
                    body: JSON.stringify({ files: filesToSave })
                });
                
                progressController.updateProgress(75, 'Verarbeite Antwort...');
                handleSaveResponse(data, progressController);
            } catch (error) {
                handleSaveError(error, progressController);
            }
        }

        function handleSaveResponse(data, progressController) {
            progressController.updateProgress(100, '');
            
            if (data.success) {
                progressController.updateProgress(100, '', `‚úÖ ${data.summary.success} Dateien erfolgreich gespeichert!`);
                resetFileSelection();
            } else {
                const status = `‚ö†Ô∏è ${data.summary.success} erfolgreich, ${data.summary.errors} Fehler`;
                progressController.updateProgress(100, '', status);
                document.getElementById('saveProgressStatus').style.color = '#e67e22';
            }
            
            // Nach 2 Sekunden automatisch ausblenden
            setTimeout(() => progressController.hide(), 2000);
        }

        /* === ERROR HANDLERS OPTIMIERT ===
         * Nutzt wiederverwendbare Error-Handling-Funktionen
         */
        function handleSaveError(error, progressController) {
            handleApiError(error, 'Speichern der Tags');
            progressController.updateProgress(100, '', '‚ùå Fehler beim Speichern der Tags');
            document.getElementById('saveProgressStatus').style.color = '#e74c3c';
            setTimeout(() => progressController.hide(), 3000);
        }

        function resetFileSelection() {
            selectedFiles.clear();
            document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
                cb.checked = false;
            });
            updateGlobalSelect();
            updateDirectorySelects();
            updateBatchButton();
        }

        /* === AUDIO RECOGNITION SYSTEM ===
         * Batch-Audio-Erkennung f√ºr fehlende Titel und K√ºnstler
         */
        function initializeAudioRecognition() {
            const recognitionBtn = document.getElementById('audioRecognitionBtn');
            if (recognitionBtn) {
                recognitionBtn.addEventListener('click', performAudioRecognition);
            }
        }

        function performAudioRecognition() {
            const recognitionBtn = document.getElementById('audioRecognitionBtn');
            const mp3Dir = '{{ mp3_dir }}'; // Aus Template-Context
            
            // Button deaktivieren
            recognitionBtn.disabled = true;
            recognitionBtn.innerHTML = 'üîç Erkenne Audio...';
            
            // Progress-System f√ºr Audio-Erkennung
            const progressController = createRecognitionProgressController();
            progressController.show();
            progressController.updateProgress(0, 'Scanne Dateien nach fehlenden Tags...');
            
            // API-Request f√ºr Batch-Audio-Erkennung mit optimierter makeApiCall
            makeApiCall('/api/batch-audio-recognition', {
                method: 'POST',
                body: JSON.stringify({ mp3_dir: mp3Dir })
            })
            .then(data => handleRecognitionResponse(data, progressController))
            .catch(error => handleRecognitionError(error, progressController))
            .finally(() => {
                recognitionBtn.disabled = false;
                recognitionBtn.innerHTML = 'üéµ Audio-Erkennung';
            });
        }

        /* === AUDIO RECOGNITION PROGRESS CONTROLLER ===
         * Nutzt die wiederverwendbare createUniversalProgressController Funktion
         */
        function createRecognitionProgressController() {
            return createUniversalProgressController({
                title: 'üéµ Audio-Erkennung l√§uft...'
            });
        }

        function handleRecognitionResponse(data, progressController) {
            progressController.updateProgress(100, '');
            
            if (data.success) {
                const stats = data.stats;
                const statusText = `‚úÖ ${stats.successful} von ${stats.total} Dateien erfolgreich erkannt!`;
                progressController.updateProgress(100, '', statusText);
                
                // Erkannte Daten direkt in die Felder einsetzen
                if (data.recognition_data) {
                    updateRecognizedFields(data.recognition_data);
                }
                
                // Kurz warten, dann Progress ausblenden
                setTimeout(() => {
                    progressController.hide();
                }, 2000);
            } else {
                progressController.updateProgress(100, '', `‚ùå ${data.message}`);
                document.getElementById('saveProgressStatus').style.color = '#e74c3c';
                
                setTimeout(() => progressController.hide(), 3000);
            }
        }

        /* === UPDATE RECOGNIZED FIELDS - OPTIMIERT ===
         * Nutzt die wiederverwendbaren updateRecognizedField Funktionen
         */
        function updateRecognizedFields(recognitionData) {
            // Durch alle erkannten Dateien iterieren
            Object.entries(recognitionData).forEach(([filepath, data]) => {
                const row = findRowByFilepath(filepath);
                if (row) {
                    // Titel-Feld aktualisieren mit utils-Funktion
                    if (data.title) {
                        const titleInput = row.querySelector('.title-input');
                        if (titleInput && !titleInput.value.trim()) {
                            updateRecognizedField(row, '.title-input', data.title, data.source, 'audio');
                            titleInput.style.fontStyle = 'italic';
                        }
                    }
                    
                    // Artist-Feld aktualisieren mit utils-Funktion
                    if (data.artist) {
                        const artistInput = row.querySelector('.artist-input');
                        if (artistInput && !artistInput.value.trim()) {
                            updateRecognizedField(row, '.artist-input', data.artist, data.source, 'audio');
                            artistInput.style.fontStyle = 'italic';
                        }
                    }
                }
            });
            
            console.log(`üéµ ${Object.keys(recognitionData).length} Felder mit erkannten Daten aktualisiert`);
        }

        function handleRecognitionError(error, progressController) {
            handleApiError(error, 'Audio-Erkennung');
            progressController.updateProgress(100, '', '‚ùå Fehler bei der Audio-Erkennung');
            document.getElementById('saveProgressStatus').style.color = '#e74c3c';
            setTimeout(() => progressController.hide(), 3000);
        }

        /* === ALBUM RECOGNITION SYSTEM ===
         * Album-Erkennung mit MusicBrainz und Discogs mit Auswahl-Dialog
         */
        function initializeAlbumRecognition() {
            const albumBtn = document.getElementById('albumRecognitionBtn');
            if (albumBtn) {
                albumBtn.addEventListener('click', performAlbumRecognition);
            }
        }

        function performAlbumRecognition() {
            const albumBtn = document.getElementById('albumRecognitionBtn');
            const mp3Dir = '{{ mp3_dir }}'; // Aus Template-Context
            
            // Nur ausgew√§hlte Dateien f√ºr Album-Erkennung
            const selectedFilePaths = Array.from(selectedFiles);
            if (selectedFilePaths.length === 0) {
                showUserMessage('Bitte w√§hlen Sie mindestens eine Datei f√ºr die Album-Erkennung aus.', 'warning');
                return;
            }
            
            // Button deaktivieren
            albumBtn.disabled = true;
            albumBtn.innerHTML = 'üîç Erkenne Album...';
            
            // Progress-System f√ºr Album-Erkennung
            const progressController = createAlbumProgressController();
            progressController.show();
            progressController.updateProgress(0, 'Analysiere Dateien f√ºr Album-Erkennung...');
            
            // API-Request f√ºr Album-Erkennung mit optimierter makeApiCall
            makeApiCall('/api/album-recognition', {
                method: 'POST',
                body: JSON.stringify({ 
                    directory: mp3Dir,
                    selected_files: selectedFilePaths
                })
            })
            .then(data => handleAlbumRecognitionResponse(data, progressController))
            .catch(error => handleAlbumRecognitionError(error, progressController))
            .finally(() => {
                albumBtn.disabled = false;
                albumBtn.innerHTML = 'üíø Album-Erkennung';
            });
        }

        /* === ALBUM RECOGNITION PROGRESS CONTROLLER ===
         * Nutzt die wiederverwendbare createUniversalProgressController Funktion
         */
        function createAlbumProgressController() {
            return createUniversalProgressController({
                title: 'ÔøΩ Album-Erkennung l√§uft...'
            });
        }

        function handleAlbumRecognitionResponse(data, progressController) {
            progressController.hide();
            
            if (data.success) {
                const candidates = data.candidates;
                
                if (candidates.length === 0) {
                    showUserMessage('Kein Album gefunden. Versuchen Sie es mit anderen Dateien oder pr√ºfen Sie die Metadaten.', 'info');
                    return;
                }
                
                // Bei hoher Konfidenz automatisch anwenden
                if (data.auto_apply && candidates.length > 0) {
                    const bestCandidate = candidates[0];
                    applyAlbumData(bestCandidate);
                    showUserMessage(`Album automatisch erkannt: "${bestCandidate.title}" von ${bestCandidate.artist} (${Math.round(bestCandidate.confidence * 100)}% Konfidenz)`, 'success', 6000);
                } else {
                    // Auswahl-Dialog anzeigen
                    showAlbumSelectionDialog(candidates);
                }
            } else {
                showUserMessage(`Album-Erkennung fehlgeschlagen: ${data.message}`, 'error');
            }
        }

        function showAlbumSelectionDialog(candidates) {
            // Dialog-HTML erstellen
            let dialogHtml = `
                <div id="albumSelectionModal" class="album-modal">
                    <div class="album-modal-content">
                        <div class="album-modal-header">
                            <h3>üíø Album-Auswahl</h3>
                            <span class="album-modal-close" onclick="closeAlbumDialog()">&times;</span>
                        </div>
                        <div class="album-modal-body">
                            <p>Mehrere m√∂gliche Alben gefunden. Bitte w√§hlen Sie das richtige Album aus:</p>
                            <div class="album-candidates">
            `;
            
            candidates.forEach((candidate, index) => {
                const confidencePercent = Math.round(candidate.confidence * 100);
                const confidenceClass = confidencePercent >= 80 ? 'high-confidence' : 
                                      confidencePercent >= 60 ? 'medium-confidence' : 'low-confidence';
                
                const artistDisplay = candidate.artist && candidate.artist.trim() ? candidate.artist : 'Unbekannter K√ºnstler';
                
                dialogHtml += `
                    <div class="album-candidate ${confidenceClass}" onclick="selectAlbumCandidate(${index})">
                        <div class="album-info">
                            <div class="album-title">${candidate.title}</div>
                            <div class="album-artist-main">von ${artistDisplay}</div>
                            <div class="album-meta">
                                ${candidate.year ? `<span class="album-year">${candidate.year}</span>` : ''}
                                <span class="album-tracks">${candidate.track_count} Tracks</span>
                                <span class="album-source">via ${candidate.source}</span>
                            </div>
                        </div>
                        <div class="album-confidence">
                            <span class="confidence-bar">
                                <span class="confidence-fill" style="width: ${confidencePercent}%"></span>
                            </span>
                            <span class="confidence-text">${confidencePercent}%</span>
                        </div>
                    </div>
                `;
            });
            
            dialogHtml += `
                            </div>
                            <div class="album-actions">
                                <button class="btn btn-secondary" onclick="closeAlbumDialog()">Keiner von denen</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Dialog in DOM einf√ºgen
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
            
            // Kandidaten-Daten f√ºr sp√§ter speichern
            window.albumCandidates = candidates;
        }

        function selectAlbumCandidate(index) {
            const candidate = window.albumCandidates[index];
            applyAlbumData(candidate);
            closeAlbumDialog();
        }

        /* === APPLY ALBUM DATA OPTIMIERT ===
         * Nutzt makeApiCall f√ºr saubere API-Kommunikation
         */
        async function applyAlbumData(albumData) {
            const mp3Dir = '{{ mp3_dir }}';
            const selectedFilePaths = Array.from(selectedFiles);
            
            try {
                // API-Request zum Anwenden der Album-Daten mit optimierter makeApiCall
                const data = await makeApiCall('/api/apply-album', {
                    method: 'POST',
                    body: JSON.stringify({
                        directory: mp3Dir,
                        selected_files: selectedFilePaths,
                        album_data: albumData
                    })
                });
                
                if (data.success) {
                    // Album-Daten in die UI eintragen
                    updateAlbumFields(data.applied_files, albumData);
                    showUserMessage(`Album-Daten auf ${data.applied_files.length} Dateien angewendet!`, 'success');
                } else {
                    showUserMessage(`Fehler beim Anwenden der Album-Daten: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Fehler beim Anwenden der Album-Daten:', error);
                showUserMessage('Fehler beim Anwenden der Album-Daten.', 'error');
            }
        }

        /* === UPDATE ALBUM FIELDS - OPTIMIERT ===
         * Nutzt die wiederverwendbaren updateRecognizedField Funktionen  
         */
        function updateAlbumFields(appliedFiles, albumData) {
            appliedFiles.forEach(fileData => {
                const row = findRowByFilepath(fileData.filename);
                if (row) {
                    // Album-Feld aktualisieren mit utils-Funktion
                    if (fileData.album) {
                        updateRecognizedField(row, '.album-input', fileData.album, albumData.source, 'album');
                    }
                    
                    // Jahr-Feld aktualisieren mit utils-Funktion
                    if (fileData.year) {
                        updateRecognizedField(row, '.year-input', fileData.year, albumData.source, 'album');
                    }
                    
                    // Track-Nummer aktualisieren mit formatierter utils-Funktion
                    if (fileData.track_number) {
                        const formattedTrack = formatTrackNumber(fileData.track_number, 2);
                        updateRecognizedField(row, '.track-input', formattedTrack, albumData.source, 'album');
                    }
                }
            });
            
            console.log(`üíø ${appliedFiles.length} Dateien mit Album-Daten aktualisiert`);
        }

        function closeAlbumDialog() {
            const modal = document.getElementById('albumSelectionModal');
            if (modal) {
                modal.remove();
            }
            delete window.albumCandidates;
        }

        function handleAlbumRecognitionError(error, progressController) {
            handleApiError(error, 'Album-Erkennung');
            progressController.updateProgress(100, '', '‚ùå Fehler bei der Album-Erkennung');
            document.getElementById('saveProgressStatus').style.color = '#e74c3c';
            setTimeout(() => progressController.hide(), 3000);
        }
    </script>
</body>
</html>
