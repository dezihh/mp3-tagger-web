<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 Tagger Web - Ergebnisse</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="results-header">
        <h1>MP3 Tagger Web - Ergebnisse</h1>
        <div class="directory-info">
            <h2>üìÅ {{ mp3_dir }}</h2>
            <p>{{ statistics.total_files }} MP3-Dateien in {{ statistics.total_directories }} Verzeichnissen 
               ({{ "%.1f"|format(statistics.total_size_mb) }} MB)</p>
        </div>
    </div>
    
    <div class="controls-bar">
        <div class="global-controls">
            <label class="checkbox-container">
                <input type="checkbox" id="select-all-global">
                <span class="checkmark"></span>
                Alle Dateien ausw√§hlen/abw√§hlen
            </label>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="batch-process" disabled>
                Ausgew√§hlte verarbeiten (0)
            </button>
            <a href="/" class="btn btn-secondary">‚Üê Zur√ºck</a>
        </div>
    </div>

    <div class="results-container">
        {% for directory, files in grouped_files.items() %}
        <div class="directory-group">
            <div class="directory-header">
                <h3>üìÇ {{ directory }}</h3>
                <div class="directory-controls">
                    <label class="checkbox-container">
                        <input type="checkbox" class="select-all-directory" data-directory="{{ directory }}">
                        <span class="checkmark"></span>
                        Alle in diesem Ordner ({{ files|length }})
                    </label>
                </div>
            </div>
            
            <div class="mp3-table-container">
                <table class="mp3-table">
                    <thead>
                        <tr>
                            <th class="col-select">Auswahl</th>
                            <th class="col-play">‚ñ∂</th>
                            <th class="col-filename">Dateiname</th>
                            <th class="col-track">Track#</th>
                            <th class="col-title">Titel</th>
                            <th class="col-artist">Artist</th>
                            <th class="col-album">Album</th>
                            <th class="col-cover">Cover</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                        <tr class="mp3-row" data-directory="{{ directory }}" data-filepath="{{ file.file_path }}">
                            <td class="col-select">
                                <label class="checkbox-container">
                                    <input type="checkbox" class="file-checkbox" 
                                           data-directory="{{ directory }}"
                                           data-filepath="{{ file.file_path }}">
                                    <span class="checkmark"></span>
                                </label>
                            </td>
                            <td class="col-play">
                                <button class="play-btn" data-filepath="{{ file.file_path }}" title="Abspielen">
                                    ‚ñ∂
                                </button>
                            </td>
                            <td class="col-filename" title="{{ file.filename }}">
                                <span class="filename hover-target">{{ file.filename }}</span>
                                <span class="file-size">({{ "%.1f"|format(file.size / 1024 / 1024) }} MB)</span>
                            </td>
                            <td class="col-track">
                                <input type="text" class="track-input" value="{{ file.track_number }}" 
                                       data-original="{{ file.track_number }}" maxlength="3">
                            </td>
                            <td class="col-title">
                                <input type="text" class="title-input" value="{{ file.title }}" 
                                       data-original="{{ file.title }}">
                            </td>
                            <td class="col-artist">
                                <input type="text" class="artist-input" value="{{ file.artist }}" 
                                       data-original="{{ file.artist }}">
                            </td>
                            <td class="col-album">
                                <input type="text" class="album-input" value="{{ file.album }}" 
                                       data-original="{{ file.album }}">
                            </td>
                            <td class="col-cover">
                                <span class="cover-status {{ 'has-cover' if file.cover_status != 'Nein' else 'no-cover' }}" 
                                      title="Cover-Status: {{ file.cover_status }}">
                                    {{ file.cover_status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Audio Player (versteckt) -->
    <audio id="audio-player" preload="none"></audio>

    <script>
        // Globale Variablen
        let selectedFiles = new Set();
        let currentAudio = null;
        let currentPlayButton = null;
        let tooltipElement = null;
        let tooltipTimeout = null;

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeControls();
            initializePlayback();
            initializeTooltips();
            updateBatchButton();
        });

        // Initialisierung der Auswahlkontrollen
        function initializeControls() {
            // Globale "Alle ausw√§hlen/abw√§hlen"
            const globalSelect = document.getElementById('select-all-global');
            globalSelect.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.file-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    toggleFileSelection(cb.dataset.filepath, this.checked);
                });
                updateDirectorySelects();
                updateBatchButton();
            });

            // Verzeichnis-spezifische "Alle ausw√§hlen/abw√§hlen"
            const directorySelects = document.querySelectorAll('.select-all-directory');
            directorySelects.forEach(select => {
                select.addEventListener('change', function() {
                    const directory = this.dataset.directory;
                    const checkboxes = document.querySelectorAll(`.file-checkbox[data-directory="${directory}"]`);
                    
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                        toggleFileSelection(cb.dataset.filepath, this.checked);
                    });
                    updateGlobalSelect();
                    updateBatchButton();
                });
            });

            // Einzelne Datei-Checkboxen
            const fileCheckboxes = document.querySelectorAll('.file-checkbox');
            fileCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    toggleFileSelection(this.dataset.filepath, this.checked);
                    updateDirectorySelects();
                    updateGlobalSelect();
                    updateBatchButton();
                });
            });
        }

        // Datei-Auswahl umschalten
        function toggleFileSelection(filepath, selected) {
            if (selected) {
                selectedFiles.add(filepath);
            } else {
                selectedFiles.delete(filepath);
            }
        }

        // Verzeichnis-Auswahl-Status aktualisieren
        function updateDirectorySelects() {
            const directorySelects = document.querySelectorAll('.select-all-directory');
            directorySelects.forEach(select => {
                const directory = select.dataset.directory;
                const checkboxes = document.querySelectorAll(`.file-checkbox[data-directory="${directory}"]`);
                const checkedBoxes = document.querySelectorAll(`.file-checkbox[data-directory="${directory}"]:checked`);
                
                if (checkedBoxes.length === 0) {
                    select.indeterminate = false;
                    select.checked = false;
                } else if (checkedBoxes.length === checkboxes.length) {
                    select.indeterminate = false;
                    select.checked = true;
                } else {
                    select.indeterminate = true;
                    select.checked = false;
                }
            });
        }

        // Globale Auswahl-Status aktualisieren
        function updateGlobalSelect() {
            const globalSelect = document.getElementById('select-all-global');
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                globalSelect.indeterminate = false;
                globalSelect.checked = false;
            } else if (checkedBoxes.length === allCheckboxes.length) {
                globalSelect.indeterminate = false;
                globalSelect.checked = true;
            } else {
                globalSelect.indeterminate = true;
                globalSelect.checked = false;
            }
        }

        // Batch-Button aktualisieren
        function updateBatchButton() {
            const batchButton = document.getElementById('batch-process');
            const count = selectedFiles.size;
            
            batchButton.textContent = `Ausgew√§hlte verarbeiten (${count})`;
            batchButton.disabled = count === 0;
        }

        // Playback-Funktionalit√§t initialisieren
        function initializePlayback() {
            const playButtons = document.querySelectorAll('.play-btn');
            const audioPlayer = document.getElementById('audio-player');
            
            playButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filepath = this.dataset.filepath;
                    togglePlayback(this, filepath, audioPlayer);
                });
            });
        }

        // Playback umschalten
        function togglePlayback(button, filepath, audioPlayer) {
            if (currentAudio && !currentAudio.paused && currentPlayButton === button) {
                // Stoppe aktuellen Track
                currentAudio.pause();
                button.textContent = "‚ñ∂";
                button.classList.remove('playing');
                currentAudio = null;
                currentPlayButton = null;
            } else {
                // Stoppe anderen Track falls vorhanden
                if (currentAudio) {
                    currentAudio.pause();
                    if (currentPlayButton) {
                        currentPlayButton.textContent = "‚ñ∂";
                        currentPlayButton.classList.remove('playing');
                    }
                }
                
                // Starte neuen Track - entferne f√ºhrende '/' f√ºr Flask-Routing
                let cleanPath = filepath.startsWith('/') ? filepath.substring(1) : filepath;
                audioPlayer.src = `/audio/${encodeURIComponent(cleanPath)}`;
                
                audioPlayer.play().then(() => {
                    button.textContent = "‚è∏";
                    button.classList.add('playing');
                    currentAudio = audioPlayer;
                    currentPlayButton = button;
                }).catch(error => {
                    console.error('Fehler beim Abspielen:', error);
                    alert('Fehler beim Abspielen der Datei: ' + error.message);
                });
            }
            
            // Event-Listener f√ºr Ende des Tracks
            audioPlayer.addEventListener('ended', function() {
                if (currentPlayButton) {
                    currentPlayButton.textContent = "‚ñ∂";
                    currentPlayButton.classList.remove('playing');
                }
                currentAudio = null;
                currentPlayButton = null;
            });
        }

        // Tooltip-Funktionalit√§t initialisieren
        function initializeTooltips() {
            // Tooltip-Element erstellen
            tooltipElement = document.createElement('div');
            tooltipElement.className = 'mp3-tooltip';
            document.body.appendChild(tooltipElement);

            // Event-Listener f√ºr alle Dateinamen
            const filenames = document.querySelectorAll('.filename');
            filenames.forEach(filenameElement => {
                const row = filenameElement.closest('.mp3-row');
                const filepath = row.dataset.filepath;

                filenameElement.addEventListener('mouseenter', function(e) {
                    showTooltip(e, filepath);
                });

                filenameElement.addEventListener('mouseleave', function() {
                    hideTooltip();
                });

                filenameElement.addEventListener('mousemove', function(e) {
                    updateTooltipPosition(e);
                });
            });
        }

        // Tooltip anzeigen
        function showTooltip(event, filepath) {
            clearTimeout(tooltipTimeout);
            
            // Sofort Lade-Anzeige zeigen
            tooltipElement.innerHTML = '<div class="tooltip-loading">Lade MP3-Informationen</div>';
            tooltipElement.classList.add('show');
            updateTooltipPosition(event);

            // MP3-Informationen abrufen
            const encodedPath = encodeURIComponent(filepath);
            fetch(`/api/mp3-info?filepath=${encodedPath}`)
                .then(response => response.json())
                .then(data => {
                    if (tooltipElement.classList.contains('show')) {
                        renderTooltipContent(data);
                    }
                })
                .catch(error => {
                    if (tooltipElement.classList.contains('show')) {
                        tooltipElement.innerHTML = '<div class="tooltip-error">Fehler beim Laden der Informationen</div>';
                    }
                });
        }

        // Tooltip verstecken
        function hideTooltip() {
            tooltipTimeout = setTimeout(() => {
                tooltipElement.classList.remove('show');
            }, 100);
        }

        // Tooltip-Position aktualisieren
        function updateTooltipPosition(event) {
            const tooltip = tooltipElement;
            const margin = 10;
            let x = event.pageX + margin;
            let y = event.pageY + margin;

            // Verhindere, dass Tooltip √ºber Bildschirmrand hinausgeht
            const tooltipRect = tooltip.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (x + tooltipRect.width > windowWidth) {
                x = event.pageX - tooltipRect.width - margin;
            }

            if (y + tooltipRect.height > windowHeight) {
                y = event.pageY - tooltipRect.height - margin;
            }

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        // Tooltip-Inhalt rendern
        function renderTooltipContent(data) {
            if (data.error) {
                tooltipElement.innerHTML = `<div class="tooltip-error">${data.error}</div>`;
                return;
            }

            let leftColumnHtml = '';
            let rightColumnHtml = '';

            // Technische Informationen - Links
            if (data.technical && Object.keys(data.technical).length > 0) {
                leftColumnHtml += '<div class="tooltip-section">';
                leftColumnHtml += '<div class="tooltip-header">üìÑ Datei-Info</div>';
                leftColumnHtml += '<div class="tooltip-content">';
                
                Object.entries(data.technical).forEach(([key, value]) => {
                    const labels = {
                        'file_path': 'Datei',
                        'file_size': 'Gr√∂√üe', 
                        'duration': 'Dauer',
                        'bitrate': 'Bitrate',
                        'sample_rate': 'Sample Rate',
                        'channels': 'Kan√§le'
                    };
                    leftColumnHtml += `<div class="tooltip-label">${labels[key] || key}:</div>`;
                    leftColumnHtml += `<div class="tooltip-value">${value}</div>`;
                });
                
                leftColumnHtml += '</div></div>';
            }

            // Basis-Tags - Links
            if (data.basic && Object.keys(data.basic).length > 0) {
                leftColumnHtml += '<div class="tooltip-section">';
                leftColumnHtml += '<div class="tooltip-header">üéµ ID3-Tags</div>';
                leftColumnHtml += '<div class="tooltip-content">';
                
                Object.entries(data.basic).forEach(([key, value]) => {
                    leftColumnHtml += `<div class="tooltip-label">${key}:</div>`;
                    leftColumnHtml += `<div class="tooltip-value">${value}</div>`;
                });
                
                leftColumnHtml += '</div></div>';
            }

            // Erweiterte Tags - Links
            if (data.extended && Object.keys(data.extended).length > 0) {
                leftColumnHtml += '<div class="tooltip-section">';
                leftColumnHtml += '<div class="tooltip-header">‚ûï Erweiterte Tags</div>';
                leftColumnHtml += '<div class="tooltip-content">';
                
                Object.entries(data.extended).forEach(([key, value]) => {
                    leftColumnHtml += `<div class="tooltip-label">${key}:</div>`;
                    leftColumnHtml += `<div class="tooltip-value">${value}</div>`;
                });
                
                leftColumnHtml += '</div></div>';
            }

            // Cover-Informationen - Rechts
            if (data.cover) {
                rightColumnHtml += '<div class="tooltip-section">';
                rightColumnHtml += '<div class="tooltip-header">üñºÔ∏è Cover</div>';
                
                if (data.cover.error) {
                    rightColumnHtml += `<div class="tooltip-error">${data.cover.error}</div>`;
                } else {
                    // Cover-Vorschau zuerst
                    if (data.cover.data) {
                        rightColumnHtml += '<div class="tooltip-cover">';
                        rightColumnHtml += `<img src="data:image/jpeg;base64,${data.cover.data}" alt="Cover Preview">`;
                        rightColumnHtml += '</div>';
                    }
                    
                    // Cover-Details
                    rightColumnHtml += '<div class="tooltip-content">';
                    rightColumnHtml += `<div class="tooltip-label">Aufl√∂sung:</div>`;
                    rightColumnHtml += `<div class="tooltip-value">${data.cover.width}√ó${data.cover.height}</div>`;
                    rightColumnHtml += `<div class="tooltip-label">Gr√∂√üe:</div>`;
                    rightColumnHtml += `<div class="tooltip-value">${data.cover.size}</div>`;
                    rightColumnHtml += `<div class="tooltip-label">Format:</div>`;
                    rightColumnHtml += `<div class="tooltip-value">${data.cover.format}</div>`;
                    rightColumnHtml += '</div>';
                }
                
                rightColumnHtml += '</div>';
            }

            // Struktur zusammenbauen
            let html = '<div class="tooltip-main-container">';
            
            if (leftColumnHtml) {
                html += `<div class="tooltip-left-column">${leftColumnHtml}</div>`;
            }
            
            if (rightColumnHtml) {
                html += `<div class="tooltip-right-column">${rightColumnHtml}</div>`;
            }
            
            html += '</div>';

            if (!leftColumnHtml && !rightColumnHtml) {
                html = '<div class="tooltip-error">Keine Informationen verf√ºgbar</div>';
            }

            tooltipElement.innerHTML = html;
        }
    </script>
</body>
</html>
